From d5972c52336e01ceefaecd6fec24414cf58419da Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Mon, 27 Mar 2023 22:04:39 +0200
Subject: [PATCH 44/57] Revert "maple_tree: Add smp_rmb() to dead node
 detection"

This reverts commit d902d25b0f5cbc925417ade7ef4251c10ca0ee08.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 lib/maple_tree.c | 8 ++------
 1 file changed, 2 insertions(+), 6 deletions(-)

diff --git a/lib/maple_tree.c b/lib/maple_tree.c
index 72c89eb03..5202d89ba 100644
--- a/lib/maple_tree.c
+++ b/lib/maple_tree.c
@@ -539,11 +539,9 @@ static inline struct maple_node *mte_parent(const struct maple_enode *enode)
  */
 static inline bool ma_dead_node(const struct maple_node *node)
 {
-	struct maple_node *parent;
+	struct maple_node *parent = (void *)((unsigned long)
+					     node->parent & ~MAPLE_NODE_MASK);
 
-	/* Do not reorder reads from the node prior to the parent check */
-	smp_rmb();
-	parent = (void *)((unsigned long) node->parent & ~MAPLE_NODE_MASK);
 	return (parent == node);
 }
 
@@ -558,8 +556,6 @@ static inline bool mte_dead_node(const struct maple_enode *enode)
 	struct maple_node *parent, *node;
 
 	node = mte_to_node(enode);
-	/* Do not reorder reads from the node prior to the parent check */
-	smp_rmb();
 	parent = mte_parent(enode);
 	return (parent == node);
 }
-- 
2.40.0.71.g950264636c

