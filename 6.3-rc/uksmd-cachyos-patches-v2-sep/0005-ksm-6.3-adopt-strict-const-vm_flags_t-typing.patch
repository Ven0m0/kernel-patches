From 962921efc6187c4ee6d4763871c42fd1f6985ff9 Mon Sep 17 00:00:00 2001
From: Oleksandr Natalenko <oleksandr@natalenko.name>
Date: Mon, 6 Mar 2023 22:10:38 +0100
Subject: [PATCH 5/5] ksm-6.3: adopt strict const vm_flags_t typing

Signed-off-by: Oleksandr Natalenko <oleksandr@natalenko.name>
---
 include/linux/ksm.h |  4 ++--
 mm/ksm.c            | 10 ++++------
 mm/madvise.c        |  4 ++++
 3 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/include/linux/ksm.h b/include/linux/ksm.h
index 632a1a792..57ed92987 100644
--- a/include/linux/ksm.h
+++ b/include/linux/ksm.h
@@ -17,9 +17,9 @@
 
 #ifdef CONFIG_KSM
 int ksm_madvise_merge(struct mm_struct *mm, struct vm_area_struct *vma,
-		unsigned long *vm_flags);
+		const vm_flags_t *vm_flags);
 int ksm_madvise_unmerge(struct vm_area_struct *vma, unsigned long start,
-		unsigned long end, unsigned long *vm_flags);
+		unsigned long end, const vm_flags_t *vm_flags);
 int ksm_madvise(struct vm_area_struct *vma, unsigned long start,
 		unsigned long end, int advice, unsigned long *vm_flags);
 int __ksm_enter(struct mm_struct *mm);
diff --git a/mm/ksm.c b/mm/ksm.c
index 2329e1104..486d481d9 100644
--- a/mm/ksm.c
+++ b/mm/ksm.c
@@ -2465,7 +2465,7 @@ static int ksm_scan_thread(void *nothing)
 }
 
 int ksm_madvise_merge(struct mm_struct *mm, struct vm_area_struct *vma,
-		unsigned long *vm_flags)
+		const vm_flags_t *vm_flags)
 {
 	int err;
 
@@ -2495,13 +2495,11 @@ int ksm_madvise_merge(struct mm_struct *mm, struct vm_area_struct *vma,
 			return err;
 	}
 
-	*vm_flags |= VM_MERGEABLE;
-
 	return 0;
 }
 
 int ksm_madvise_unmerge(struct vm_area_struct *vma, unsigned long start,
-		unsigned long end, unsigned long *vm_flags)
+		unsigned long end, const vm_flags_t *vm_flags)
 {
 	int err;
 
@@ -2514,8 +2512,6 @@ int ksm_madvise_unmerge(struct vm_area_struct *vma, unsigned long start,
 			return err;
 	}
 
-	*vm_flags &= ~VM_MERGEABLE;
-
 	return 0;
 }
 
@@ -2530,12 +2526,14 @@ int ksm_madvise(struct vm_area_struct *vma, unsigned long start,
 		err = ksm_madvise_merge(mm, vma, vm_flags);
 		if (err)
 			return err;
+		*vm_flags |= VM_MERGEABLE;
 		break;
 
 	case MADV_UNMERGEABLE:
 		err = ksm_madvise_unmerge(vma, start, end, vm_flags);
 		if (err)
 			return err;
+		*vm_flags &= ~VM_MERGEABLE;
 		break;
 	}
 
diff --git a/mm/madvise.c b/mm/madvise.c
index 5d487c8d4..36e756355 100644
--- a/mm/madvise.c
+++ b/mm/madvise.c
@@ -1584,9 +1584,13 @@ SYSCALL_DEFINE3(pmadv_ksm, int, pidfd, int, behaviour, unsigned int, flags)
 		switch (behaviour) {
 			case MADV_MERGEABLE:
 				ret = ksm_madvise_merge(vma->vm_mm, vma, &vma->vm_flags);
+				if (!ret)
+					vm_flags_set(vma, VM_MERGEABLE);
 				break;
 			case MADV_UNMERGEABLE:
 				ret = ksm_madvise_unmerge(vma, vma->vm_start, vma->vm_end, &vma->vm_flags);
+				if (!ret)
+					vm_flags_clear(vma, VM_MERGEABLE);
 				break;
 			default:
 				/* look, ma, no brain */
-- 
2.39.2.501.gd9d677b2d8

