From b6b0dd76521b5a52706e3af58afa6b35cc30317e Mon Sep 17 00:00:00 2001
From: Paolo Valente <paolo.valente@linaro.org>
Date: Fri, 8 May 2020 09:46:05 +0200
Subject: [PATCH 26/35] block, bfq, DEBUG: add more logs and BUG_ONs on woken
 list

Signed-off-by: Paolo Valente <paolo.valente@linaro.org>
---
 block/bfq-iosched.c | 10 ++++++++--
 block/bfq-wf2q.c    |  2 ++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/block/bfq-iosched.c b/block/bfq-iosched.c
index 13aeda530..470d30cf0 100644
--- a/block/bfq-iosched.c
+++ b/block/bfq-iosched.c
@@ -5245,9 +5245,15 @@ static struct bfq_queue *bfq_select_queue(struct bfq_data *bfqd)
 			   bfq_serv_to_charge(blocked_bfqq->next_rq,
 					      blocked_bfqq) <=
 			   bfq_bfqq_budget_left(blocked_bfqq)
-			)
+			) {
+			bfq_log_bfqq(bfqd, bfqq,
+				     "choosing directly the blocked queue %d",
+				     bfq_get_first_task_pid(blocked_bfqq));
+			BUG_ON(blocked_bfqq == bfqq);
 			bfqq = blocked_bfqq;
-		else if (!idling_boosts_thr_without_issues(bfqd, bfqq) &&
+			bfq_log_bfqq(bfqd, bfqq,
+				     "chosen directly this blocked queue");
+		} else if (!idling_boosts_thr_without_issues(bfqd, bfqq) &&
 			 (bfqq->wr_coeff == 1 || bfqd->wr_busy_queues > 1 ||
 			  !bfq_bfqq_has_short_ttime(bfqq))) {
 			struct bfq_queue *new_bfqq;
diff --git a/block/bfq-wf2q.c b/block/bfq-wf2q.c
index dda54bb5c..b75eb1bc7 100644
--- a/block/bfq-wf2q.c
+++ b/block/bfq-wf2q.c
@@ -2088,6 +2088,8 @@ void bfq_add_bfqq_busy(struct bfq_data *bfqd, struct bfq_queue *bfqq)
 		BFQ_BUG_ON(bfqd->wr_busy_queues > bfq_tot_busy_queues(bfqd));
 	}
 
+	BFQ_BUG_ON(!hlist_unhashed(&bfqq->woken_list_node) && !bfqq->waker_bfqq);
+
 	/* Move bfqq to the head of the woken list of its waker */
 	if (!hlist_unhashed(&bfqq->woken_list_node) &&
 	    &bfqq->woken_list_node != bfqq->waker_bfqq->woken_list.first) {
-- 
2.31.1.362.g311531c9de

