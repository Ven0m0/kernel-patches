From e31bdc76aea89e14193bb5fc5880e4d679f6dd5e Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Wed, 5 Jul 2023 11:28:11 +0200
Subject: [PATCH 13/13] fork: disallow any page faults early by locking all
 VMAs

Fix proposal: https://patchwork.kernel.org/project/linux-mm/patch/20230705063711.2670599-2-surenb@google.com/#25410367

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 kernel/fork.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/kernel/fork.c b/kernel/fork.c
index 7634db0d5..810024557 100644
--- a/kernel/fork.c
+++ b/kernel/fork.c
@@ -664,6 +664,13 @@ static __latent_entropy int dup_mmap(struct mm_struct *mm,
 		retval = -EINTR;
 		goto fail_uprobe_end;
 	}
+
+	/* Disallow any page faults early by locking all VMAs. */
+	if (IS_ENABLED(CONFIG_PER_VMA_LOCK)) {
+		for_each_vma(old_vmi, mpnt)
+			vma_start_write(mpnt);
+		vma_iter_init(old_vmi, old_mm, 0);
+	}
 	flush_cache_dup_mm(oldmm);
 	uprobe_dup_mmap(oldmm, mm);
 	/*
-- 
2.41.0.159.g0bfa463d37

