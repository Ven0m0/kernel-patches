From bc79c8a38407523eaa9198d2f234327857809bc8 Mon Sep 17 00:00:00 2001
From: Tejun Heo <tj@kernel.org>
Date: Wed, 6 Mar 2024 16:11:18 -1000
Subject: [PATCH 163/167] compat.bpf.h: Add DEFINE_SCX_OPS()

---
 tools/sched_ext/include/scx/compat.bpf.h | 10 +++++++
 tools/sched_ext/scx_qmap.bpf.c           | 37 +++++++++---------------
 2 files changed, 23 insertions(+), 24 deletions(-)

diff --git a/tools/sched_ext/include/scx/compat.bpf.h b/tools/sched_ext/include/scx/compat.bpf.h
index 46a40ae37..9616b4256 100644
--- a/tools/sched_ext/include/scx/compat.bpf.h
+++ b/tools/sched_ext/include/scx/compat.bpf.h
@@ -75,3 +75,13 @@ struct sched_ext_ops___no_exit_dump_len {
 	u32 timeout_ms;
 	char name[128];
 };
+
+#define DEFINE_SCX_OPS(__name, ...)						\
+	SEC(".struct_ops.link")							\
+	struct sched_ext_ops __name = {						\
+		__VA_ARGS__,							\
+	};									\
+	SEC(".struct_ops.link")							\
+	struct sched_ext_ops___no_exit_dump_len __name##___no_exit_dump_len = {	\
+		__VA_ARGS__							\
+	};									\
diff --git a/tools/sched_ext/scx_qmap.bpf.c b/tools/sched_ext/scx_qmap.bpf.c
index b621a5f79..fd07e581d 100644
--- a/tools/sched_ext/scx_qmap.bpf.c
+++ b/tools/sched_ext/scx_qmap.bpf.c
@@ -383,27 +383,16 @@ void BPF_STRUCT_OPS(qmap_exit, struct scx_exit_info *ei)
 	uei_record(&uei, ei);
 }
 
-#define QMAP_OPS_INIT_COMMON							\
-	.select_cpu		= (void *)qmap_select_cpu,			\
-	.enqueue		= (void *)qmap_enqueue,				\
-	.dequeue		= (void *)qmap_dequeue,				\
-	.dispatch		= (void *)qmap_dispatch,			\
-	.core_sched_before	= (void *)qmap_core_sched_before,		\
-	.cpu_release		= (void *)qmap_cpu_release,			\
-	.init_task		= (void *)qmap_init_task,			\
-	.init			= (void *)qmap_init,				\
-	.exit			= (void *)qmap_exit,				\
-	.flags			= SCX_OPS_ENQ_LAST,				\
-	.timeout_ms		= 5000U,					\
-	.name			= "qmap",
-
-SEC(".struct_ops.link")
-struct sched_ext_ops qmap_ops = {
-	QMAP_OPS_INIT_COMMON
-	/* .exit_dump_len will be set while loading */
-};
-
-SEC(".struct_ops.link")
-struct sched_ext_ops___no_exit_dump_len qmap_ops___no_exit_dump_len = {
-	QMAP_OPS_INIT_COMMON
-};
+DEFINE_SCX_OPS(qmap_ops,
+	       .select_cpu		= (void *)qmap_select_cpu,
+	       .enqueue			= (void *)qmap_enqueue,
+	       .dequeue			= (void *)qmap_dequeue,
+	       .dispatch		= (void *)qmap_dispatch,
+	       .core_sched_before	= (void *)qmap_core_sched_before,
+	       .cpu_release		= (void *)qmap_cpu_release,
+	       .init_task		= (void *)qmap_init_task,
+	       .init			= (void *)qmap_init,
+	       .exit			= (void *)qmap_exit,
+	       .flags			= SCX_OPS_ENQ_LAST,
+	       .timeout_ms		= 5000U,
+	       .name			= "qmap");
-- 
2.43.0.232.ge79552d197

