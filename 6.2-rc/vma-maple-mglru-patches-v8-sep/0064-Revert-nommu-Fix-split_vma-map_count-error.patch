From 51dabd1dae9c3ad76e033a20326cd4f32d2cd3e3 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Tue, 10 Jan 2023 19:56:07 +0100
Subject: [PATCH 64/69] Revert "nommu: Fix split_vma() map_count error"

This reverts commit 3806925a21272b0720917d415ef08f6e0ef43735.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 mm/nommu.c | 4 +---
 1 file changed, 1 insertion(+), 3 deletions(-)

diff --git a/mm/nommu.c b/mm/nommu.c
index 23d75b46c..fd8fc814b 100644
--- a/mm/nommu.c
+++ b/mm/nommu.c
@@ -560,6 +560,7 @@ void vma_mas_remove(struct vm_area_struct *vma, struct ma_state *mas)
 
 static void setup_vma_to_mm(struct vm_area_struct *vma, struct mm_struct *mm)
 {
+	mm->map_count++;
 	vma->vm_mm = mm;
 
 	/* add the VMA to the mapping */
@@ -587,7 +588,6 @@ static void mas_add_vma_to_mm(struct ma_state *mas, struct mm_struct *mm,
 	BUG_ON(!vma->vm_region);
 
 	setup_vma_to_mm(vma, mm);
-	mm->map_count++;
 
 	/* add the VMA to the tree */
 	vma_mas_store(vma, mas);
@@ -1349,7 +1349,6 @@ int split_vma(struct mm_struct *mm, struct vm_area_struct *vma,
 	if (vma->vm_file)
 		return -ENOMEM;
 
-	mm = vma->vm_mm;
 	if (mm->map_count >= sysctl_max_map_count)
 		return -ENOMEM;
 
@@ -1401,7 +1400,6 @@ int split_vma(struct mm_struct *mm, struct vm_area_struct *vma,
 	mas_set_range(&mas, vma->vm_start, vma->vm_end - 1);
 	mas_store(&mas, vma);
 	vma_mas_store(new, &mas);
-	mm->map_count++;
 	return 0;
 
 err_mas_preallocate:
-- 
2.39.0.rc2.1.gbd5df96b79

