From 95ad7a412531b540bbe7e6775ce843cee70ed1c0 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 26 Jan 2023 21:27:54 +0100
Subject: [PATCH 349/353] Revert "mm: remove the swap_readpage return value"

This reverts commit 20a485c3a846da10ff008783623b7f3e313bbf26.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 mm/page_io.c | 16 +++++++++++-----
 mm/swap.h    |  7 ++++---
 2 files changed, 15 insertions(+), 8 deletions(-)

diff --git a/mm/page_io.c b/mm/page_io.c
index 84b348fe4..905d9fcc0 100644
--- a/mm/page_io.c
+++ b/mm/page_io.c
@@ -444,9 +444,11 @@ static void swap_readpage_fs(struct page *page,
 		*plug = sio;
 }
 
-void swap_readpage(struct page *page, bool synchronous, struct swap_iocb **plug)
+int swap_readpage(struct page *page, bool synchronous,
+		  struct swap_iocb **plug)
 {
 	struct bio *bio;
+	int ret = 0;
 	struct swap_info_struct *sis = page_swap_info(page);
 	bool workingset = PageWorkingset(page);
 	unsigned long pflags;
@@ -478,12 +480,15 @@ void swap_readpage(struct page *page, bool synchronous, struct swap_iocb **plug)
 		goto out;
 	}
 
-	if ((sis->flags & SWP_SYNCHRONOUS_IO) &&
-	    !bdev_read_page(sis->bdev, swap_page_sector(page), page)) {
-		count_vm_event(PSWPIN);
-		goto out;
+	if (sis->flags & SWP_SYNCHRONOUS_IO) {
+		ret = bdev_read_page(sis->bdev, swap_page_sector(page), page);
+		if (!ret) {
+			count_vm_event(PSWPIN);
+			goto out;
+		}
 	}
 
+	ret = 0;
 	bio = bio_alloc(sis->bdev, 1, REQ_OP_READ, GFP_KERNEL);
 	bio->bi_iter.bi_sector = swap_page_sector(page);
 	bio->bi_end_io = end_swap_bio_read;
@@ -515,6 +520,7 @@ void swap_readpage(struct page *page, bool synchronous, struct swap_iocb **plug)
 		psi_memstall_leave(&pflags);
 	}
 	delayacct_swapin_end();
+	return ret;
 }
 
 void __swap_read_unplug(struct swap_iocb *sio)
diff --git a/mm/swap.h b/mm/swap.h
index f5eb5069d..f78065c8e 100644
--- a/mm/swap.h
+++ b/mm/swap.h
@@ -8,7 +8,8 @@
 /* linux/mm/page_io.c */
 int sio_pool_init(void);
 struct swap_iocb;
-void swap_readpage(struct page *page, bool do_poll, struct swap_iocb **plug);
+int swap_readpage(struct page *page, bool do_poll,
+		  struct swap_iocb **plug);
 void __swap_read_unplug(struct swap_iocb *plug);
 static inline void swap_read_unplug(struct swap_iocb *plug)
 {
@@ -63,8 +64,8 @@ static inline unsigned int folio_swap_flags(struct folio *folio)
 }
 #else /* CONFIG_SWAP */
 struct swap_iocb;
-static inline void swap_readpage(struct page *page, bool do_poll,
-		struct swap_iocb **plug)
+static inline int swap_readpage(struct page *page, bool do_poll,
+				struct swap_iocb **plug)
 {
 	return 0;
 }
-- 
2.39.0.rc2.1.gbd5df96b79

