From d60b2d1fd2917993d784aafeae15b4bc18a277c5 Mon Sep 17 00:00:00 2001
From: Kent Overstreet <kent.overstreet@linux.dev>
Date: Fri, 20 Jan 2023 11:17:56 -0500
Subject: [PATCH 45/49] fixup! mm: percpu: Alloc tagging

Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>
---
 include/linux/percpu.h | 1 +
 mm/percpu-internal.h   | 6 +++++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/include/linux/percpu.h b/include/linux/percpu.h
index 84c41fd32..482deb07e 100644
--- a/include/linux/percpu.h
+++ b/include/linux/percpu.h
@@ -9,6 +9,7 @@
 #include <linux/cpumask.h>
 #include <linux/pfn.h>
 #include <linux/init.h>
+#include <linux/sched.h>
 
 #include <asm/percpu.h>
 
diff --git a/mm/percpu-internal.h b/mm/percpu-internal.h
index 1c9dc97de..02639b7a9 100644
--- a/mm/percpu-internal.h
+++ b/mm/percpu-internal.h
@@ -81,7 +81,11 @@ struct pcpu_chunk {
 
 static inline bool need_pcpuobj_ext(void)
 {
-	return !mem_cgroup_kmem_disabled();
+	if (IS_ENABLED(CONFIG_ALLOC_TAGGING))
+		return true;
+	if (!mem_cgroup_kmem_disabled())
+		return true;
+	return false;
 }
 
 extern spinlock_t pcpu_lock;
-- 
2.39.0.rc2.1.gbd5df96b79

