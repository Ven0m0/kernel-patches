From 5b7227dcb78ae1c78b0acb71031a70e346f70dbe Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Thu, 26 Jan 2023 21:27:54 +0100
Subject: [PATCH 350/355] Revert "mpage: stop using bdev_{read,write}_page"

This reverts commit d232287538d9430a0a3fe7944350d4deea5b84aa.

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 fs/mpage.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/fs/mpage.c b/fs/mpage.c
index 72e559630..d36a95473 100644
--- a/fs/mpage.c
+++ b/fs/mpage.c
@@ -269,6 +269,11 @@ static struct bio *do_mpage_readpage(struct mpage_readpage_args *args)
 
 alloc_new:
 	if (args->bio == NULL) {
+		if (first_hole == blocks_per_page) {
+			if (!bdev_read_page(bdev, blocks[0] << (blkbits - 9),
+								&folio->page))
+				goto out;
+		}
 		args->bio = bio_alloc(bdev, bio_max_segs(args->nr_pages), opf,
 				      gfp);
 		if (args->bio == NULL)
@@ -574,6 +579,11 @@ static int __mpage_writepage(struct page *page, struct writeback_control *wbc,
 
 alloc_new:
 	if (bio == NULL) {
+		if (first_unmapped == blocks_per_page) {
+			if (!bdev_write_page(bdev, blocks[0] << (blkbits - 9),
+								page, wbc))
+				goto out;
+		}
 		bio = bio_alloc(bdev, BIO_MAX_VECS,
 				REQ_OP_WRITE | wbc_to_write_flags(wbc),
 				GFP_NOFS);
-- 
2.39.0.rc2.1.gbd5df96b79

