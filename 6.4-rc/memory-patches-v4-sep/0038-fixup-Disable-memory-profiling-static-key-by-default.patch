From 8cd38a8e04fe154e39955f75ce183ea5ff1cacb4 Mon Sep 17 00:00:00 2001
From: Suren Baghdasaryan <surenb@google.com>
Date: Thu, 25 May 2023 20:36:33 +0000
Subject: [PATCH 38/47] fixup! Disable memory profiling static key by default

Signed-off-by: Suren Baghdasaryan <surenb@google.com>
---
 Documentation/admin-guide/kernel-parameters.txt | 2 +-
 include/linux/alloc_tag.h                       | 4 ++--
 lib/alloc_tag.c                                 | 8 ++++----
 3 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/Documentation/admin-guide/kernel-parameters.txt b/Documentation/admin-guide/kernel-parameters.txt
index 2fd8e56b7..16a2a539c 100644
--- a/Documentation/admin-guide/kernel-parameters.txt
+++ b/Documentation/admin-guide/kernel-parameters.txt
@@ -3770,7 +3770,7 @@
 
 	nomce		[X86-32] Disable Machine Check Exception
 
-	nomem_profiling	Disable memory allocation profiling.
+	mem_profiling	Enable memory allocation profiling.
 
 	nomfgpt		[X86-32] Disable Multi-Function General Purpose
 			Timer usage (for AMD Geode machines).
diff --git a/include/linux/alloc_tag.h b/include/linux/alloc_tag.h
index f2b2f66cb..a8403a874 100644
--- a/include/linux/alloc_tag.h
+++ b/include/linux/alloc_tag.h
@@ -35,11 +35,11 @@ static inline struct alloc_tag *ct_to_alloc_tag(struct codetag *ct)
 	__section("alloc_tags") = { .ct = CODE_TAG_INIT };		\
 	struct alloc_tag * __maybe_unused _old = alloc_tag_save(&_alloc_tag)
 
-extern struct static_key_true mem_alloc_profiling_key;
+extern struct static_key_false mem_alloc_profiling_key;
 
 static inline bool mem_alloc_profiling_enabled(void)
 {
-	return static_branch_likely(&mem_alloc_profiling_key);
+	return static_branch_unlikely(&mem_alloc_profiling_key);
 }
 
 #ifdef CONFIG_MEM_ALLOC_PROFILING_DEBUG
diff --git a/lib/alloc_tag.c b/lib/alloc_tag.c
index b8b92290d..f9332e7cd 100644
--- a/lib/alloc_tag.c
+++ b/lib/alloc_tag.c
@@ -10,7 +10,7 @@
 
 static struct codetag_type *alloc_tag_cttype;
 
-DEFINE_STATIC_KEY_TRUE(mem_alloc_profiling_key);
+DEFINE_STATIC_KEY_FALSE(mem_alloc_profiling_key);
 
 /*
  * Won't need to be exported once page allocation accounting is moved to the
@@ -18,12 +18,12 @@ DEFINE_STATIC_KEY_TRUE(mem_alloc_profiling_key);
  */
 EXPORT_SYMBOL(mem_alloc_profiling_key);
 
-static int __init mem_alloc_profiling_disable(char *s)
+static int __init mem_alloc_profiling_enable(char *s)
 {
-	static_branch_disable(&mem_alloc_profiling_key);
+	static_branch_enable(&mem_alloc_profiling_key);
 	return 1;
 }
-__setup("nomem_profiling", mem_alloc_profiling_disable);
+__setup("mem_profiling", mem_alloc_profiling_enable);
 
 struct alloc_tag_file_iterator {
 	struct codetag_iterator ct_iter;
-- 
2.40.1.445.gf85cd430b1

