From 6ce9b5f73240e361bc82b1489a1263bc03ca7109 Mon Sep 17 00:00:00 2001
From: Kent Overstreet <kent.overstreet@linux.dev>
Date: Tue, 30 May 2023 00:37:22 -0400
Subject: [PATCH 46/50] Finish rename from alloc_tagging -> mem_profiling

Signed-off-by: Kent Overstreet <kent.overstreet@linux.dev>
---
 MAINTAINERS                                         | 7 +++----
 include/linux/gfp.h                                 | 2 +-
 include/linux/{alloc_tag.h => mem_profiling.h}      | 6 +++---
 include/linux/mempool.h                             | 2 +-
 include/linux/mm.h                                  | 2 +-
 include/linux/percpu.h                              | 2 +-
 include/linux/{pgalloc_tag.h => pg_mem_profiling.h} | 8 ++++----
 include/linux/slab.h                                | 2 +-
 lib/Makefile                                        | 1 -
 mm/Makefile                                         | 1 +
 mm/huge_memory.c                                    | 2 +-
 mm/page_alloc.c                                     | 2 +-
 mm/page_ext.c                                       | 2 +-
 lib/alloc_tag.c => mm/profiling.c                   | 2 +-
 14 files changed, 20 insertions(+), 21 deletions(-)
 rename include/linux/{alloc_tag.h => mem_profiling.h} (97%)
 rename include/linux/{pgalloc_tag.h => pg_mem_profiling.h} (93%)
 rename lib/alloc_tag.c => mm/profiling.c (99%)

diff --git a/MAINTAINERS b/MAINTAINERS
index c00979a62..b9c920bd5 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
@@ -13504,10 +13504,9 @@ MEMORY ALLOCATION PROFILING
 M:	Suren Baghdasaryan <surenb@google.com>
 M:	Kent Overstreet <kent.overstreet@linux.dev>
 S:	Maintained
-F:	include/linux/alloc_tag.h
-F:	include/linux/codetag_ctx.h
-F:	lib/alloc_tag.c
-F:	lib/pgalloc_tag.c
+F:	include/linux/mem_profiling.h
+F:	include/linux/pg_mem_profiling.h
+F:	mm/profiling.c
 
 MEMORY CONTROLLER DRIVERS
 M:	Krzysztof Kozlowski <krzysztof.kozlowski@linaro.org>
diff --git a/include/linux/gfp.h b/include/linux/gfp.h
index 3d2e9ab8c..55467b41f 100644
--- a/include/linux/gfp.h
+++ b/include/linux/gfp.h
@@ -6,7 +6,7 @@
 
 #include <linux/mmzone.h>
 #include <linux/topology.h>
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 #include <linux/sched.h>
 
 struct vm_area_struct;
diff --git a/include/linux/alloc_tag.h b/include/linux/mem_profiling.h
similarity index 97%
rename from include/linux/alloc_tag.h
rename to include/linux/mem_profiling.h
index 787d69e2d..e392b1386 100644
--- a/include/linux/alloc_tag.h
+++ b/include/linux/mem_profiling.h
@@ -2,8 +2,8 @@
 /*
  * allocation tagging
  */
-#ifndef _LINUX_ALLOC_TAG_H
-#define _LINUX_ALLOC_TAG_H
+#ifndef _LINUX_MEM_PROFILING_H
+#define _LINUX_MEM_PROFILING_H
 
 #include <linux/bug.h>
 #include <linux/codetag.h>
@@ -136,4 +136,4 @@ static inline void alloc_tag_add(union codetag_ref *ref, struct alloc_tag *tag,
 	_res;								\
 })
 
-#endif /* _LINUX_ALLOC_TAG_H */
+#endif /* _LINUX_MEM_PROFILING_H */
diff --git a/include/linux/mempool.h b/include/linux/mempool.h
index 9fa126aa1..3c0595fd7 100644
--- a/include/linux/mempool.h
+++ b/include/linux/mempool.h
@@ -6,7 +6,7 @@
 #define _LINUX_MEMPOOL_H
 
 #include <linux/sched.h>
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 #include <linux/wait.h>
 #include <linux/compiler.h>
 
diff --git a/include/linux/mm.h b/include/linux/mm.h
index f5969cb85..451af0571 100644
--- a/include/linux/mm.h
+++ b/include/linux/mm.h
@@ -5,7 +5,7 @@
 #include <linux/errno.h>
 #include <linux/mmdebug.h>
 #include <linux/gfp.h>
-#include <linux/pgalloc_tag.h>
+#include <linux/pg_mem_profiling.h>
 #include <linux/bug.h>
 #include <linux/list.h>
 #include <linux/mmzone.h>
diff --git a/include/linux/percpu.h b/include/linux/percpu.h
index dc50dedb0..6d2a8e1eb 100644
--- a/include/linux/percpu.h
+++ b/include/linux/percpu.h
@@ -2,7 +2,7 @@
 #ifndef __LINUX_PERCPU_H
 #define __LINUX_PERCPU_H
 
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 #include <linux/mmdebug.h>
 #include <linux/preempt.h>
 #include <linux/smp.h>
diff --git a/include/linux/pgalloc_tag.h b/include/linux/pg_mem_profiling.h
similarity index 93%
rename from include/linux/pgalloc_tag.h
rename to include/linux/pg_mem_profiling.h
index 0cbba1386..65cdd35f4 100644
--- a/include/linux/pgalloc_tag.h
+++ b/include/linux/pg_mem_profiling.h
@@ -2,10 +2,10 @@
 /*
  * page allocation tagging
  */
-#ifndef _LINUX_PGALLOC_TAG_H
-#define _LINUX_PGALLOC_TAG_H
+#ifndef _LINUX_PG_MEM_PROFILING_H
+#define _LINUX_PG_MEM_PROFILING_H
 
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 
 #ifdef CONFIG_MEM_ALLOC_PROFILING
 
@@ -90,4 +90,4 @@ static inline void pgalloc_tag_split(struct page *page, unsigned int nr) {}
 
 #endif /* CONFIG_MEM_ALLOC_PROFILING */
 
-#endif /* _LINUX_PGALLOC_TAG_H */
+#endif /* _LINUX_PG_MEM_PROFILING_H */
diff --git a/include/linux/slab.h b/include/linux/slab.h
index 916928d18..bb0502b3e 100644
--- a/include/linux/slab.h
+++ b/include/linux/slab.h
@@ -453,7 +453,7 @@ static __always_inline unsigned int __kmalloc_index(size_t size,
 static_assert(PAGE_SHIFT <= 20);
 #define kmalloc_index(s) __kmalloc_index(s, true)
 
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 
 void *__kmalloc(size_t size, gfp_t flags) __assume_kmalloc_alignment __alloc_size(1);
 
diff --git a/lib/Makefile b/lib/Makefile
index 8d09ccb4d..1434aee30 100644
--- a/lib/Makefile
+++ b/lib/Makefile
@@ -229,7 +229,6 @@ obj-$(CONFIG_OF_RECONFIG_NOTIFIER_ERROR_INJECT) += \
 obj-$(CONFIG_FUNCTION_ERROR_INJECTION) += error-inject.o
 
 obj-$(CONFIG_CODE_TAGGING) += codetag.o
-obj-$(CONFIG_MEM_ALLOC_PROFILING) += alloc_tag.o
 
 lib-$(CONFIG_GENERIC_BUG) += bug.o
 
diff --git a/mm/Makefile b/mm/Makefile
index e29afc890..a1cd04a24 100644
--- a/mm/Makefile
+++ b/mm/Makefile
@@ -137,3 +137,4 @@ obj-$(CONFIG_IO_MAPPING) += io-mapping.o
 obj-$(CONFIG_HAVE_BOOTMEM_INFO_NODE) += bootmem_info.o
 obj-$(CONFIG_GENERIC_IOREMAP) += ioremap.o
 obj-$(CONFIG_SHRINKER_DEBUG) += shrinker_debug.o
+obj-$(CONFIG_MEM_ALLOC_PROFILING) += profiling.o
diff --git a/mm/huge_memory.c b/mm/huge_memory.c
index 221cce005..d32291770 100644
--- a/mm/huge_memory.c
+++ b/mm/huge_memory.c
@@ -37,7 +37,7 @@
 #include <linux/page_owner.h>
 #include <linux/sched/sysctl.h>
 #include <linux/memory-tiers.h>
-#include <linux/pgalloc_tag.h>
+#include <linux/pg_mem_profiling.h>
 
 #include <asm/tlb.h>
 #include <asm/pgalloc.h>
diff --git a/mm/page_alloc.c b/mm/page_alloc.c
index 040d2c51d..fb79c8e26 100644
--- a/mm/page_alloc.c
+++ b/mm/page_alloc.c
@@ -74,7 +74,7 @@
 #include <linux/psi.h>
 #include <linux/khugepaged.h>
 #include <linux/delayacct.h>
-#include <linux/pgalloc_tag.h>
+#include <linux/pg_mem_profiling.h>
 #include <asm/sections.h>
 #include <asm/tlbflush.h>
 #include <asm/div64.h>
diff --git a/mm/page_ext.c b/mm/page_ext.c
index 55ba797f8..8ed0a54d8 100644
--- a/mm/page_ext.c
+++ b/mm/page_ext.c
@@ -10,7 +10,7 @@
 #include <linux/page_idle.h>
 #include <linux/page_table_check.h>
 #include <linux/rcupdate.h>
-#include <linux/pgalloc_tag.h>
+#include <linux/pg_mem_profiling.h>
 
 /*
  * struct page extension
diff --git a/lib/alloc_tag.c b/mm/profiling.c
similarity index 99%
rename from lib/alloc_tag.c
rename to mm/profiling.c
index d9c92ac33..cdaacf293 100644
--- a/lib/alloc_tag.c
+++ b/mm/profiling.c
@@ -1,5 +1,5 @@
 // SPDX-License-Identifier: GPL-2.0-only
-#include <linux/alloc_tag.h>
+#include <linux/mem_profiling.h>
 #include <linux/debugfs.h>
 #include <linux/fs.h>
 #include <linux/gfp.h>
-- 
2.41.0

